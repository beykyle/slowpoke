\documentclass{article}
\usepackage{amsthm}
\usepackage{amsmath}
\usepackage{siunitx}
\usepackage{mathtools}
\DeclarePairedDelimiter\ceil{\lceil}{\rceil}
\DeclarePairedDelimiter\floor{\lfloor}{\rfloor}

\sisetup{output-exponent-marker=\ensuremath{\mathrm{e}}}


\title{Derivation of Numerical Slowing Down Equations for Homogenous Mixture of Fuel and Absorber}
\author{Kyle Beyer}
\begin{document}
\maketitle

The following discussion is sourced from educational materials and lecture notes provided in NERS 561 at the University of 
Michigan, during the WN2020 semester, with Professor Yang.

We're interested in running deterministic, multigroup transport calculations on a reactor core, to determine
it's reactivity as a function of state points - control rod positions, temperature, moderator flow rate, etc.
These libraries can be generated by doing neutron slowing down calculations on a fuel assembly to determine 
neutron spectra across each coarse energy group.
These relatively computationally cheap calculations can be repeated quickly for many state points, 
allowing reactor designers to generate a table of  multigroup cross sections for 
each background cross sections $\sigma_b^i = \sum_{j \neq i} N_j \sigma_j$, where each 
background cross section corresponds to a reactor state point of interest.
Using this library, whole core transport methods can be used that treat space and angle withna higher fidelity,
by using a few-energy group calculation that still preserves energy features of interest, i.e. resonance self-shielding. 


Let's take a look at a very simple example: a homogenized fuel assumby made up of just 
two nuclides, an absorber nuclide (e.g. U238) and 
a moderator nuclide (e.g. H1). 
This simple system allows us to use a simple numerical slowing down scheme to calculate the shape of the neutron flux
in the slowing down range (below the fission neutron energy, above thermal energies)
as a function of the number density ratio of the absorber to the moderator $N_m/N_a$; or equivalently, as a function of the
background cross section $\sigma_b = \Sigma^m_p / N_a$, where $\Sigma_p$ is a potential scattering cross section. 
This then allows us to generate a multigroup cross section library for a tabulated list of backround cross sections.

For simpicity's sake, we are going to treat our fuel assumbly as infinite - Eq.\,\ref{eq:slow} is
effectively is an integration of a full steady-state transport equation over space and solid angle. 
Further, we are confining ourselves to an energy region where fission can be ignored and 
scatterring energy distributions are uniform.
It is possible to include an escape term in our slowing down equations to account for simple geomeetries - like 
an infinite fuel lattice, but we will keep things simple for now.

Our system is parameterized by:

\begin{itemize}
    \item $\sigma_s^a$, $\sigma_s^m$, the absorber and moderator (respectively) microscopic scattering cross sections
    \item  $\sigma_a^a$, $\sigma_a^m$, the absorber and moderator (respectively) microscopic absorption cross sections, 
    \item $\alpha_a$, $\alpha_m$, where $\alpha = \frac{(A-1)^2}{(A+1)^2}$, and $A_a$, $A_m$ are the respective nuclear 
        masses of the absorber and moderator, in units of neutron masses.
    \item $N_m/N_a$, the number density ratio if moderator to absorber
\end{itemize}

        We have the total cross section for a species 
        $\sigma_t  =\sigma_a + \sigma_s$
        Ignoring fission and  other reactions is a good approximation in our energy range of interest.

        We have the lethargy ($u$) dependent 
        analytical nuetron slowing down euqation in a homogenous material, for multiple nuclides indexed by $j$:

        \begin{equation}
            \label{eq:slow}
            \sum_j N_j \sigma_t^j(u) \phi(u) = 
            \sum_j \int_{u - \epsilon_j}^{u} N_j \sigma_s^j(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_j}du'
        \end{equation}

        Here $\epsilon_j = \log{(1/\alpha_j)}$ is the maximum lethargy gain from scattering on nuclide $j$. 
        We omit any source distribution over our lethargy range. 
        We will further exam our boundary conditions later.
        
        Explicitly writing this out for our two nuclides, absorber $a$ and moderator $m$, we have:

        \begin{equation}
            \big(N_a \sigma_t^a(u) + N_m \sigma_t^m(u) \big)  \phi(u) = 
            \int_{u - \epsilon_a}^{u} N_a \sigma_s^a(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_a}du'  + 
            \int_{u - \epsilon_m}^{u} N_m \sigma_s^m(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_m}du'  
        \end{equation}
        
        Dividing through by $N_a$, and denoting the ratio $N_m/N_a \equiv r$:
        
        \begin{equation}
            \big(r \sigma_t^a(u) + \sigma_t^m(u) \big)  \phi(u) = 
            \int_{u - \epsilon_a}^{u} \sigma_s^a(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_a}du'  + 
            \int_{u - \epsilon_m}^{u} r \sigma_s^m(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_m}du'. \label{eqn}
        \end{equation}

        This is the analytical equation we want to solve. 
        To do so, let's define an equal lethargy grid, with $I-1$ groups, 
        numbered from 1 through $I$. 
        Each group has width $\Delta u_i << \epsilon_a < \epsilon_m$, 
        and lethargy is tabulated at each of the $I$ group edges,
        from $u_0 = 0; E_0 = E_\text{max}$
        to some $u_I  = \log{(E_\text{max}/E_\text{min})}$. 
        Let's also define a lethargy group averaging operator over lethargy group $i$: 
        $\int_{u_{i-1}}^{u_i}  $. 
             

        Applying this operator to \ref{eqn}:

         \begin{align}
             \int_{u_{i-1}}^{u_i} 
            \big(r \sigma_t^a(u) + \sigma_t^m(u) \big)  \phi(u) \; du &= 
             \int_{u_{i-1}}^{u_i} 
            \bigg(  
            \int_{u - \epsilon_a}^{u} \sigma_s^a(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_a}du'  
            \bigg)  \; du \\ &+ 
             \int_{u_{i-1}}^{u_i} 
            \bigg(  
            \int_{u - \epsilon_m}^{u} r \sigma_s^m(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_m}du'.
            \bigg)  \; du 
         \end{align}

         Next, we make the approximation that our cross sections and fluxes are constant over the groups:

         \begin{align}
             \phi(u) &= \phi_i & u_{i-1} < u < u_i &               \; \; \\
             \sigma_k^j(u) &= \sigma_{ki}^j & u_{i-1} < u < u_i &,  \; \;  
             \forall \sigma_k \in \{\sigma_a,\sigma_s,\sigma_t\}. 
         \end{align}

         First, we write the collision term:

          \begin{equation} 
             \int_{u_{i-1}}^{u_i} 
            \big(r \sigma_t^a(u) + \sigma_t^m(u) \big)  \phi(u) \; du = 
            \big( r \sigma_{ti}^a + \sigma_{ti}^m  \big) \phi_i \Delta u_i
          \end{equation}

          The in-scattering term into group $i$ will be a sum of contributions from lesser lethargy groups $l$.
          Contributions from the absorber will run from same-group in-scattering to the group
          with lower lethargy bound a distance of the maximum lethargy gain away from the group in 
          question: 
          $l \in \{ \; l \: | \: u_{l-1} \geq u_i - \epsilon_a  \} $
          Scattering off the moderator will have contributions from a larger set of groups, 
          $l \in \{ \; l \: | \ u_{l-1} \geq u_i - \epsilon_m  \} $. 
          Applying the lethargy group averaging operator to the RHS of Eq.\:\ref{eqn}:
          

         \begin{align}            
             \int_{u_{i-1}}^{u_{i}} 
            \bigg(  
            \int_{u - \epsilon_a}^{u} \sigma_s^a(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_a}du'  
            \bigg)  \; du + 
            \int_{(i-1)\Delta u_i}^{i \Delta u_i} 
            \bigg(  
            \int_{u - \epsilon_m}^{u} r \sigma_s^m(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_m}du'.
        \bigg)  \; du  = \\
             \int_{u_{i-1}}^{u_{i}} 
            \bigg(  
                \int_{u - \epsilon_a}^{u_{i-1}} \sigma_s^a(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_a}du'  +
                \int_{u_{i-1}}^{u} \sigma_s^a(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_a}du'  
            \bigg)  \; du + \\
             \int_{u_{i-1}}^{u_{i}} 
            \bigg(  
                \int_{u - \epsilon_m}^{u_{i-1}} r \sigma_s^m(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_m}du' +
                \int_{u_{i-1}}^{u} r \sigma_s^m(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_m}du'.
            \bigg)  \; du  
         \end{align}
         
         The integral on the bounds $[u_{i-1}, u_i]$ represents scattering events 
         that don't leave group $i$:

         \begin{align}
             \int_{u_{i-1}}^{u_{i}} 
            \bigg(  
                \int_{u_{i-1}}^{u_{i}} r \sigma_s^m(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_m}du'.
            \bigg)  \; du  \\ =   
            \frac{r \sigma_{si}^m \phi_i}{1-\alpha_m} 
            \int_{u_{i-1}}^{u_{i}} du e^{-u} \int_{u_{i-1}}^{u_{i}} du' e^{u'} \\ =
            \frac{r \sigma_{si}^m \phi_i}{1-\alpha_m} \big( \Delta u_i -1 + e^{-\Delta u_i} \big)
         \end{align}

         The absorber same-group scattering term can be derived identically:

         \begin{equation}
            \frac{\sigma_{si}^m \phi_i}{1-\alpha_a} \big( \Delta u_i -1 + e^{-\Delta u_i} \big)
         \end{equation}


         We can rewrite the bounds of the other integral, $u \in [u_{i-1} - \epsilon_{j}, u_{i-1}]$, as \\
         $l \in [ i - \frac{\epsilon_j}{\Delta u_i},i-1]$.  
         We must be careful here, however, if our moderator is hydrogen, 
         it is likely that $\frac{\epsilon_m}{\Delta u_i} > I $.
         In other words, as we aren't modeling thermal or fission spectrum energies, 
         the lethargy range of our problem is likely less than the maximum lethargy gain from
         our presumably hydrogenous moderator. 

         For the absorber however, most likely dozens to hundreds
         into the lethargy range of interest; each group will only have in-scatter
         from a limited subset of lower lethargy groups. 
         The range
         $l \in [ i - \frac{\epsilon_a}{\Delta u_i},i-1]$ will be useful, 
         except for in the first  $\frac{\epsilon_a}{\Delta u_i}$ groups.
         
         We can define 

         \begin{equation}
             n = 
             \begin{cases} 
              i - \frac{\epsilon_j}{\Delta u_i} & \frac{\epsilon_j}{\Delta u_i} + 1< i \\
              0 & \frac{\epsilon_j}{\Delta u_i}  + 1 > i   
             \end{cases}
         \end{equation}

         and use the range 
         $l \in [ n,i-1]$. 

         However, this does not preserve our $1/(1-\alpha_j)$ scattering distributions for groups 
         $[1, \floor*{ \frac{\epsilon_j}{\Delta u} }]$. 
         This will be discussed later when we get into boundary conditions.


         Using this new terminology, let's see how applying the group averaging operator to the in-scatter
         term looks for the moderator:

         \begin{align}
             \int_{u_{i-1}}^{u_{i}} 
            \bigg(  
                \int_{u - \epsilon_m}^{u_{i-1}} &r \sigma_s^m(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_m}du'.
            \bigg)  \; du   \\ =
             \int_{u_{i-1}}^{u_{i}} 
            \bigg(  
                \int_{0}^{u_{i-1}} &r \sigma_s^m(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_m}du'.
            \bigg)  \; du   \\ &=
            \frac{1}{1-\alpha_m} \sum_{l = 0}^{i-1} r \sigma_{sl}^m \phi_l 
            \int_{u_{i-1}}^{u_{i}} du \int_{u_{l-1}}^{u_{l}} du' e^{-(u-u')} \\ &=
            \frac{1}{1-\alpha_m} 
            \sum_{l = 0}^{i-1} r \sigma_{sl}^m \phi_l  (e^{u_l} - e^{u_{l-1}}) (e^{-u_{i-1}} - e^{-u_{i}}) 
         \end{align}

         We can derive the term for the absorber nearly identically:

         \begin{align}
             \int_{u_{i-1}}^{u_{i}} 
            \bigg(  
                \int_{u - \epsilon_a}^{u_{i-1}} & \sigma_s^a(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_a}du'.
            \bigg)  \; du   \\ &=
            \frac{1}{1-\alpha_a} \sum_{l = n}^{i-1} \sigma_{sl}^a \phi_l  (e^{u_l} - e^{u_{l-1}}) (e^{-u_{i-1}} - e^{-u_{i}}) 
         \end{align}

         Putting our scattering term together:
        \begin{align}
        \begin{split}
            \int_{u_{i-1}}^{u_{i}} &
            \bigg(  
                \int_{u - \epsilon_a}^{u_{i-1}} \sigma_s^a(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_a}du'  +
                \int_{u_{i-1}}^{u} \sigma_s^a(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_a}du'  
            \bigg)  \; du \\ +
            \int_{u_{i-1}}^{u_{i}} &
            \bigg(  
                \int_{u - \epsilon_m}^{u_{i-1}} r \sigma_s^m(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_m}du' +
                \int_{u_{i-1}}^{u} r \sigma_s^m(u')\phi(u') \frac{e^{-(u-u')}}{1 - \alpha_m}du'.
            \bigg)  \; du  \\ = 
            &\frac{r \sigma_{si}^m \phi_i}{1-\alpha_m} \big( \Delta u_i -1 + e^{-\Delta u_i} \big)+
            \frac{\sigma_{si}^m \phi_i}{1-\alpha_a} \big( \Delta u_i -1 + e^{-\Delta u_i} \big) \\ 
            & + \frac{1}{1-\alpha_a} 
                \sum_{l = n}^{i-1} \sigma_{sl}^a \phi_l  (e^{u_l} - e^{u_{l-1}})   (e^{-u_{i-1}} - e^{-u_{i}}) \\ 
            & + \frac{1}{1-\alpha_m} 
                \sum_{l = 0}^{i-1} r \sigma_{sl}^m \phi_l  (e^{u_l} - e^{u_{l-1}}) (e^{-u_{i-1}} - e^{-u_{i}}) 
        \end{split}
        \end{align}

        We have no source term, so at this point we are ready to write the neutron balance equation in a 
        group:

        \begin{align}
        \begin{split}
            \label{eq:balance_group}
            \big( r \sigma_{ti}^a + \sigma_{ti}^m  \big) &\phi_i \Delta u_i \\=
            &\frac{r \sigma_{si}^m \phi_i}{1-\alpha_m} \big( \Delta u_i -1 + e^{-\Delta u_i} \big)+
            \frac{\sigma_{si}^a \phi_i}{1-\alpha_a} \big( \Delta u_i -1 + e^{-\Delta u_i} \big) \\ 
            & + \frac{1}{1-\alpha_a} 
                \sum_{l = n}^{i-1} \sigma_{sl}^a \phi_l  (e^{u_l} - e^{u_{l-1}})   (e^{-u_{i-1}} - e^{-u_{i}}) \\ 
            & + \frac{1}{1-\alpha_m} 
                \sum_{l = 0}^{i-1} r \sigma_{sl}^m \phi_l  (e^{u_l} - e^{u_{l-1}}) (e^{-u_{i-1}} - e^{-u_{i}}) 
        \end{split}
        \end{align}

        By grouping terms of the same group $i$, we can see this is a lower triangular system:

        \begin{align}
        \begin{split}
            \label{eq:ltri}
            \bigg[ 
                \bigg( r \sigma_{ti}^a + \sigma_{ti}^m  \bigg) \Delta u_i  - 
                \bigg( \frac{r \sigma_{si}^m }{1-\alpha_m} + \frac{\sigma_{si}^a }{1-\alpha_a}  \bigg)
                \bigg( \Delta u_i -1 + e^{-\Delta u_i} \bigg) 
            \bigg] \phi_i \\ =
              \frac{1}{1-\alpha_a} 
                \sum_{l = n}^{i-1} \sigma_{sl}^a \phi_l  (e^{u_l} - e^{u_{l-1}})   (e^{-u_{i-1}} - e^{-u_{i}}) \\ 
             + \frac{1}{1-\alpha_m} 
                \sum_{l = 0}^{i-1} r \sigma_{sl}^m \phi_l  (e^{u_l} - e^{u_{l-1}}) (e^{-u_{i-1}} - e^{-u_{i}}) 
        \end{split}
        \end{align}

        with solution:
        
        \begin{align}
        \begin{split}
            \label{eq:soln}
            \phi_i =
            \frac{
               \frac{1}{1-\alpha_a} 
                \sum_{l = n}^{i-1} \sigma_{sl}^a \phi_l  (e^{u_l} - e^{u_{l-1}})   (e^{-u_{i-1}} - e^{-u_{i}}) 
             + \frac{1}{1-\alpha_m} 
                \sum_{l = 0}^{i-1} r \sigma_{sl}^m \phi_l  (e^{u_l} - e^{u_{l-1}}) (e^{-u_{i-1}} - e^{-u_{i}}) 
            }
            {  
                \bigg( r \sigma_{ti}^a + \sigma_{ti}^m  \bigg) \Delta u_i  - 
                \bigg( \frac{r \sigma_{si}^m }{1-\alpha_m} + \frac{\sigma_{si}^a }{1-\alpha_a}  \bigg)
                \bigg( \Delta u_i -1 + e^{-\Delta u_i} \bigg) 
             }
        \end{split}
        \end{align}

        We could easily generalize this to an arbitrary number of nuclides with cross sections $\Sigma_k^j$ for 
        reaction $k \in \{s,a,t\}$:
        
        \begin{align}
        \begin{split}
            \label{eq:soln}
            \phi_i =
                \sum_j \bigg[
            \frac{
                \sum_{l = n}^{i-1} \frac{ \Sigma_{sl}^j }{1-\alpha_j}  \phi_l  
                (e^{u_l} - e^{u_{l-1}})   (e^{-u_{i-1}} - e^{-u_{i}}) 
            }
            {  
               \Sigma_{ti}^j  \Delta u_i  - 
                \big( \frac{ \Sigma_{si}^j }{1-\alpha_j}  \big)
            \big( \Delta u_i -1 + e^{-\Delta u_i} \big) 
             }
         \bigg]
        \end{split}
        \end{align}
        
        
        However, we've neglected to represent in-scattering from groups with lethargies greater than 
        $u_0$. Groups with $i < \floor{\epsilon_j/\Delta u}]$ will have an incomplete scattering source - 
        neutrons can come from groups $[0 , \floor{\epsilon_j/\Delta u}]$, but neutrons at lower
        energies that are not represented on the gird are neglected. 
        We will use an asymptotic scattering source , by assuming $\sigma_s(u) = \sigma_p$ and 
        $\phi(u) = 1$ above $E_0$. 
        We only care abou the flux shape, and we're well out of the fission range, so this is a good approximation.
        
        This means we have an additional source term in the numerator of 
        lethargy groups $[0,\epsilon_j/\Delta u]$, for each nuclide $j$,
        representing in-scattering from an asymptotic scattering source from
        all lethargies below 0.
        We can represent this term using potential scattering cross sections $\sigma_p$:
        
        \begin{align}
            \frac{ N_j \sigma_{p}^j }{1-\alpha_j}
                (e^{u_i} - e^{u_{i+\epsilon_j/\Delta u}})  (e^{-u_{i-1}} - e^{-u_{i}}) 
        \end{align}

        So that our full equation looks like this:
        
        \begin{align}
        \begin{split}
            \label{eq:soln}
            \phi_i = 
            \sum_j \bigg[
            \frac{
                \sum_{l = 0}^{i-1} \frac{ \Sigma_{sl}^j }{1-\alpha_j}  \phi_l  
                (e^{u_l} - e^{u_{l-1}})  
                +
                 \frac{N_j  \sigma_{p}^j }{1-\alpha_j}  \phi_l  
                 (e^{u_0} - e^{u_n})   
            }
            {  
                \Sigma_{ti}^j  \Delta u_i  - 
                \big( \frac{ \Sigma_{si}^j }{1-\alpha_j}  \big)
            \big( \Delta u_i -1 + e^{-\Delta u_i} \big)  
             }
         \bigg]
        \end{split}
        \end{align}

        which can be cast into a more familiar form
        
        \begin{align}
        \begin{split}
            \label{eq:soln}
            \phi_i = 
            (e^{-u_{i-1}} - e^{-u_{i}}) 
            \sum_j \bigg[
            \frac{
                \sum_{l = 0}^{i-1} \frac{ \Sigma_{sl}^j }{1-\alpha_j}  \phi_l  
                (e^{u_l} - e^{u_{l-1}})  
                +
                 \frac{N_j  \sigma_{p}^j }{1-\alpha_j}  \phi_l  
                 (e^{u_0} - e^{u_n})   
            }
            {  
                \Sigma_{ti}^j  \Delta u_i  - 
                \big( \frac{ \Sigma_{si}^j }{1-\alpha_j}  \big)
            \big( \Delta u_i -1 + e^{-\Delta u_i} \big)  
             }
         \bigg]
        \end{split}
        \end{align}


        Now we have everything we need to solve this system numerically, given a set of cross sections.

        Let's look at some parameters for an example problem.
        Using H-1 as our moderator, we have 
        $A_m = 0.9992$, so we have a
        maximum fractional energy loss in our problem of $\alpha_m = 1.600e-7$, and 
        maximum lethargy gain of $\epsilon_m = 15.648$. 
        For a typical absorber, U-238, we have 
        $A_a = 236.006$, so we have a
        maximum fractional energy loss in our problem of $\alpha_a = 0.9832$, and 
        maximum lethargy gain of $\epsilon_a = 1.6949e-2$, from scattering on the absorber. 
        
        
        The main constraint on the number of groups is that the lethargy groups must be small
        enough to have constant cross sections over the resolved resonance region of the absorber.
        Note that the above derivation does not require equal lethargy groups.
        Choosing 1 eV and 20 keV as our energy bounds, we have a maximum lethargy of $9.903$.
        Choosing $\frac{\epsilon_a}{\Delta u_i} = 2e4$, meaning $2e4$ lethargy groups 
        covering the range of the maximum lethargy gain from the absorber in the problem, 
        gives us a group width of $\Delta u_i = 1.776e-5$,
        which gives us 557,708 groups in the problem lethargy space, if we adjust to a 
        minimum energy of 1.0004753 eV. 
        I'm just going to use 1 eV, because percision is overrated.
    
\end{document}
